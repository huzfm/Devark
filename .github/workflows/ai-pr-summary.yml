name: AI PR Summary

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Get PR diff
      - name: Get PR diff
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          git diff origin/${{ github.event.pull_request.base.ref }}...pr > pr.diff

      # Step 3: Generate AI summary using Groq
      - name: Generate AI PR summary
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          node <<'EOF'
          import fs from "fs";
          import fetch from "node-fetch";

          const diff = fs.readFileSync("pr.diff", "utf8").slice(0, 12000);

          const prompt = `
          You are an expert software engineer.

          Summarize this GitHub Pull Request in simple terms.

          PR Title:
          ${process.env.PR_TITLE}

          PR Description:
          ${process.env.PR_BODY}

          Code Changes:
          ${diff}

          Provide:
          - What was changed
          - Why it was changed
          - Any risks or things reviewers should check
          `;

          const response = await fetch(
            "https://api.groq.com/openai/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Authorization": \`Bearer \${process.env.GROQ_API_KEY}\`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "llama3-70b-8192",
                messages: [{ role: "user", content: prompt }]
              })
            }
          );

          const result = await response.json();
          const summary = result.choices[0].message.content;

          fs.writeFileSync("summary.txt", summary);
          EOF

      # Step 4: Post or update PR comment
      - name: Post summary as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const summary = fs.readFileSync("summary.txt", "utf8");

            const marker = "<!-- AI_PR_SUMMARY -->";
            const body = `${marker}
            ## ðŸ¤– AI PR Summary

            ${summary}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
