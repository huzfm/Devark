name: AI PR Summary

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # Step 1: Checkout repository
      # ---------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get PR diff
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          git diff origin/${{ github.event.pull_request.base.ref }}...pr > pr.diff

      - name: Generate AI PR summary
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          node <<'EOF'
          import fs from "fs";

          const diff = fs.readFileSync("pr.diff", "utf8").slice(0, 12000);

          const prompt =
            "You are an expert software engineer.\n\n" +
            "Summarize the following GitHub Pull Request clearly for reviewers.\n\n" +
            "PR Title:\n" + process.env.PR_TITLE + "\n\n" +
            "PR Description:\n" + (process.env.PR_BODY || "No description provided.") + "\n\n" +
            "Code Diff:\n" + diff + "\n\n" +
            "Provide:\n" +
            "- Summary of changes\n" +
            "- Why these changes were made\n";

          const response = await fetch(
            "https://api.groq.com/openai/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Authorization": "Bearer " + process.env.GROQ_API_KEY,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                messages: [
                  { role: "user", content: prompt }
                ]
              })
            }
          );

          const result = await response.json();

          if (!result || !result.choices || !result.choices.length) {
            console.error("Invalid Groq response:", result);
            process.exit(1);
          }

          fs.writeFileSync(
            "summary.txt",
            result.choices[0].message.content
          );
          EOF

      - name: Post AI summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const summary = fs.readFileSync("summary.txt", "utf8");
            const marker = "<!-- AI_PR_SUMMARY -->";

            const body =
              marker +
              "\n## ðŸ¤– AI PR Summary\n\n" +
              summary;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
