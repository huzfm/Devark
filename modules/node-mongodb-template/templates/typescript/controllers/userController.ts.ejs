import { Request, Response } from "express";
import User, { IUser } from "../models/userModel.js";

// Get all users
export const getUsers = async (req: Request, res: Response) => {
try {
const users = await User.find().select("-__v");
res.status(200).json({
success: true,
data: users,
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error fetching users",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};

// Get single user by ID
export const getUserById = async (req: Request, res: Response) => {
try {
const user = await User.findById(req.params.id).select("-__v");
if (!user) {
return res.status(404).json({
success: false,
message: "User not found",
});
}
res.status(200).json({
success: true,
data: user,
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error fetching user",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};

// Create new user
export const createUser = async (req: Request, res: Response) => {
try {
const user: IUser = new User(req.body);
const savedUser = await user.save();
res.status(201).json({
success: true,
data: savedUser,
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error creating user",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};

// Update user
export const updateUser = async (req: Request, res: Response) => {
try {
const user = await User.findByIdAndUpdate(
req.params.id,
{ $set: req.body },
{ new: true, runValidators: true }
).select("-__v");

if (!user) {
return res.status(404).json({
success: false,
message: "User not found",
});
}

res.status(200).json({
success: true,
data: user,
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error updating user",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};

// Delete user
export const deleteUser = async (req: Request, res: Response) => {
try {
const user = await User.findByIdAndDelete(req.params.id);

if (!user) {
return res.status(404).json({
success: false,
message: "User not found",
});
}

res.status(200).json({
success: true,
message: "User deleted successfully",
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error deleting user",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};

// Search users
export const searchUsers = async (req: Request, res: Response) => {
try {
const { query } = req.query;
const searchQuery = query
? {
$or: [
{ name: { $regex: query, $options: "i" } },
{ email: { $regex: query, $options: "i" } },
],
}
: {};

const users = await User.find(searchQuery).select("-__v");
res.status(200).json({
success: true,
data: users,
});
} catch (error) {
res.status(500).json({
success: false,
message: "Error searching users",
error: error instanceof Error ? error.message : "Unknown error",
});
}
};